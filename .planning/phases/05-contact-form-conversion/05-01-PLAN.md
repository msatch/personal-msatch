---
phase: 05-contact-form-conversion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/schemas/contact.ts
  - src/lib/resend.ts
  - src/app/[locale]/contact/actions.ts
  - messages/es.json
  - messages/en.json
  - .env.example
autonomous: true
requirements:
  - CONT-01
  - CONT-02
  - CONT-03
  - CONT-04
  - CONT-05
  - CONT-06
  - CONT-07

must_haves:
  truths:
    - "Server action validates form data with Zod and returns typed field errors on failure"
    - "Server action sends email via Resend on valid submission and returns success state"
    - "Honeypot field detection silently discards bot submissions with a fake success response"
    - "Both es.json and en.json contain the complete contact.* namespace with matching key structures"
  artifacts:
    - path: "src/lib/schemas/contact.ts"
      provides: "Shared Zod 4 validation schema for contact form"
      exports: ["contactSchema", "ContactFormData"]
    - path: "src/lib/resend.ts"
      provides: "Resend client initialization"
      exports: ["resend"]
    - path: "src/app/[locale]/contact/actions.ts"
      provides: "Server action for contact form submission"
      exports: ["submitContactForm", "ContactFormState"]
    - path: "messages/es.json"
      provides: "Spanish contact form translations"
      contains: "contact"
    - path: "messages/en.json"
      provides: "English contact form translations"
      contains: "contact"
  key_links:
    - from: "src/app/[locale]/contact/actions.ts"
      to: "src/lib/schemas/contact.ts"
      via: "import contactSchema"
      pattern: "import.*contactSchema.*from.*schemas/contact"
    - from: "src/app/[locale]/contact/actions.ts"
      to: "src/lib/resend.ts"
      via: "import resend client"
      pattern: "import.*resend.*from.*lib/resend"

user_setup:
  - service: resend
    why: "Email delivery for contact form submissions"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (resend.com) -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Create account and get API key"
        location: "resend.com -> Sign up -> Dashboard -> API Keys"
      - task: "Verify sending domain (mgripe.com) -- can use onboarding@resend.dev for development"
        location: "Resend Dashboard -> Domains -> Add Domain"
---

<objective>
Build the contact form backend infrastructure: shared Zod validation schema, Resend email client, server action with honeypot detection and email delivery, and bilingual contact form translations.

Purpose: Creates all server-side and data plumbing so the UI (Plan 02) can render a form that validates, submits, and sends email with zero additional backend work.
Output: Zod schema, Resend client, server action, and complete `contact.*` translation namespace in both languages.
</objective>

<execution_context>
@C:/Users/matia/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-contact-form-conversion/05-RESEARCH.md
@messages/es.json
@messages/en.json
@src/app/[locale]/contact/page.tsx
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, create Zod schema and Resend client</name>
  <files>
    src/lib/schemas/contact.ts
    src/lib/resend.ts
    .env.example
  </files>
  <action>
1. Install new dependencies:
   ```bash
   npm install zod resend
   ```

2. Create `src/lib/schemas/contact.ts` with a shared Zod 4 validation schema:
   - Export `contactSchema` using `z.object()` with these fields:
     - `name`: `z.string().min(1, { error: 'Required' }).max(200)`
     - `email`: `z.string().min(1, { error: 'Required' }).email({ error: 'Invalid email' })`
     - `message`: `z.string().min(10, { error: 'Too short' }).max(5000)`
     - `company`: `z.string().max(200).optional()`
     - `serviceInterest`: `z.string().max(100).optional()`
   - Export `ContactFormData` type via `z.infer<typeof contactSchema>`
   - NOTE: Use Zod 4's unified `error` parameter (NOT `message` or `required_error`). Check the installed version -- if zod@3.x is installed instead of 4.x, use `{ message: '...' }` syntax instead.

3. Create `src/lib/resend.ts`:
   - Import `Resend` from `'resend'`
   - Export a `resend` instance: `new Resend(process.env.RESEND_API_KEY)`
   - Add a comment noting the API key must be server-only (no NEXT_PUBLIC_ prefix)

4. Update `.env.example` -- append these variables (preserve existing content):
   ```
   RESEND_API_KEY=re_your_api_key_here
   RESEND_FROM_EMAIL=M. Gripe Website <noreply@mgripe.com>
   RESEND_TO_EMAIL=contact@mgripe.com
   WHATSAPP_NUMBER=5215512345678
   ```
  </action>
  <verify>
    - `npm ls zod resend` shows both packages installed
    - `src/lib/schemas/contact.ts` exports `contactSchema` and `ContactFormData`
    - `src/lib/resend.ts` exports `resend`
    - `.env.example` contains RESEND_API_KEY, RESEND_FROM_EMAIL, RESEND_TO_EMAIL, WHATSAPP_NUMBER
  </verify>
  <done>Zod and Resend are installed. Shared validation schema defines all 5 form fields with appropriate constraints. Resend client is initialized from env var. .env.example documents all required environment variables.</done>
</task>

<task type="auto">
  <name>Task 2: Create server action and bilingual contact translations</name>
  <files>
    src/app/[locale]/contact/actions.ts
    messages/es.json
    messages/en.json
  </files>
  <action>
1. Create `src/app/[locale]/contact/actions.ts` with `'use server'` directive:

   - Export `ContactFormState` type:
     ```typescript
     export type ContactFormState = {
       success: boolean | null;
       errors?: Record<string, string[]>;
       message?: string;
     };
     ```

   - Export `submitContactForm(prevState: ContactFormState, formData: FormData): Promise<ContactFormState>`:
     a. **Honeypot check (CONT-05):** Read `formData.get('website_url')`. If it has a value, return `{ success: true, message: 'success' }` (fake success, silent discard).
     b. **Extract raw data:** Get `name`, `email`, `message`, `company`, `serviceInterest` from formData. Use `|| undefined` for optional fields so empty strings become undefined.
     c. **Validate with Zod (CONT-03):** Call `contactSchema.safeParse(rawData)`. If validation fails, return `{ success: false, errors: result.error.flatten().fieldErrors }` with flattened field errors.
     d. **Send email via Resend (CONT-04):** Call `resend.emails.send()` with:
        - `from`: Use `process.env.RESEND_FROM_EMAIL || 'M. Gripe Website <onboarding@resend.dev>'` (fallback to Resend test domain for development)
        - `to`: `[process.env.RESEND_TO_EMAIL || 'contact@mgripe.com']`
        - `replyTo`: validated `email` from form data
        - `subject`: `New contact from ${name}` (use validated name)
        - `html`: Build a simple HTML email template including all form fields (name, email, company if provided, service interest if provided, message). Use a helper function `buildEmailHtml(data: ContactFormData): string` defined in the same file.
     e. **On success (CONT-06):** Return `{ success: true, message: 'success' }`
     f. **On Resend error (CONT-07):** Catch the error, `console.error` it, return `{ success: false, message: 'server_error' }`

   - Create `buildEmailHtml(data: ContactFormData): string` helper in the same file:
     - Simple HTML email showing: Name, Email, Company (if provided), Service Interest (if provided), Message
     - Use basic inline CSS for readability (no external stylesheets in email)
     - Include a horizontal rule before the message body for visual separation

2. Add `contact` namespace to `messages/es.json` (add at the TOP of the JSON object, before existing keys, to keep new content visible during development):

   ```json
   "contact": {
     "title": "Hablemos",
     "subtitle": "Completa el formulario y te responderemos en 24-48 horas habiles.",
     "fields": {
       "name": {
         "label": "Nombre",
         "placeholder": "Tu nombre completo"
       },
       "email": {
         "label": "Email",
         "placeholder": "tu@email.com"
       },
       "company": {
         "label": "Empresa",
         "placeholder": "Tu empresa (opcional)"
       },
       "serviceInterest": {
         "label": "Servicio de interes",
         "placeholder": "Selecciona un servicio (opcional)",
         "options": {
           "advisory": "Asesoria Tecnica Estrategica",
           "delivery": "Aceleracion de Delivery",
           "alignment": "Alineacion de Producto y Negocio",
           "fractional": "Liderazgo Fraccional",
           "other": "Otro"
         }
       },
       "message": {
         "label": "Mensaje",
         "placeholder": "Cuentanos sobre tu proyecto o desafio..."
       },
       "submit": {
         "label": "Enviar mensaje",
         "sending": "Enviando..."
       }
     },
     "errors": {
       "nameRequired": "El nombre es obligatorio.",
       "emailRequired": "El email es obligatorio.",
       "emailInvalid": "Por favor ingresa un email valido.",
       "messageRequired": "El mensaje es obligatorio.",
       "messageTooShort": "El mensaje debe tener al menos 10 caracteres.",
       "serverError": "Hubo un error al enviar tu mensaje. Por favor intenta nuevamente."
     },
     "success": {
       "title": "Mensaje enviado!",
       "message": "Gracias por contactarnos. Te responderemos dentro de 24-48 horas habiles.",
       "backHome": "Volver al inicio"
     }
   }
   ```

   NOTE on accents: The existing es.json may or may not use accented characters. Match the established convention. If existing copy uses ASCII-safe text (no accents), keep that pattern. If existing copy uses proper accents (e.g., "diagnostico" vs "diagn√≥stico"), use accents. Check the existing file and follow the convention.

3. Add the matching `contact` namespace to `messages/en.json` with identical key structure:

   ```json
   "contact": {
     "title": "Let's Talk",
     "subtitle": "Fill out the form and we'll get back to you within 24-48 business hours.",
     "fields": {
       "name": {
         "label": "Name",
         "placeholder": "Your full name"
       },
       "email": {
         "label": "Email",
         "placeholder": "you@email.com"
       },
       "company": {
         "label": "Company",
         "placeholder": "Your company (optional)"
       },
       "serviceInterest": {
         "label": "Service of interest",
         "placeholder": "Select a service (optional)",
         "options": {
           "advisory": "Strategic Technical Advisory",
           "delivery": "Delivery Acceleration",
           "alignment": "Product & Business Alignment",
           "fractional": "Fractional Leadership",
           "other": "Other"
         }
       },
       "message": {
         "label": "Message",
         "placeholder": "Tell us about your project or challenge..."
       },
       "submit": {
         "label": "Send message",
         "sending": "Sending..."
       }
     },
     "errors": {
       "nameRequired": "Name is required.",
       "emailRequired": "Email is required.",
       "emailInvalid": "Please enter a valid email address.",
       "messageRequired": "Message is required.",
       "messageTooShort": "Message must be at least 10 characters.",
       "serverError": "There was an error sending your message. Please try again."
     },
     "success": {
       "title": "Message sent!",
       "message": "Thank you for reaching out. We'll get back to you within 24-48 business hours.",
       "backHome": "Back to home"
     }
   }
   ```

   IMPORTANT: Ensure the `contact` key is added without breaking existing JSON structure. Both files must have identical key paths (different values).
  </action>
  <verify>
    - `src/app/[locale]/contact/actions.ts` has `'use server'` directive at the top
    - TypeScript compiles without errors: `npx tsc --noEmit` (or check relevant files)
    - `messages/es.json` and `messages/en.json` both parse as valid JSON: `node -e "require('./messages/es.json'); require('./messages/en.json'); console.log('OK')"`
    - Both JSON files contain `contact.title`, `contact.fields.name.label`, `contact.errors.nameRequired`, `contact.success.title` keys
    - Server action imports `contactSchema` from `@/lib/schemas/contact` and `resend` from `@/lib/resend`
  </verify>
  <done>Server action validates with Zod, checks honeypot, sends email via Resend, and returns typed state. Both translation files contain the complete `contact.*` namespace with field labels, placeholders, error messages, success messages, and service options in both Spanish and English.</done>
</task>

</tasks>

<verification>
1. Dependencies installed: `npm ls zod resend` shows both packages
2. TypeScript compilation: `npx tsc --noEmit` passes (or no errors in new files)
3. Translation parity: Both es.json and en.json have identical `contact.*` key structures
4. Server action exports: `submitContactForm` and `ContactFormState` are exported from actions.ts
5. Schema exports: `contactSchema` and `ContactFormData` are exported from contact.ts
6. Env documented: `.env.example` has RESEND_API_KEY, RESEND_FROM_EMAIL, RESEND_TO_EMAIL, WHATSAPP_NUMBER
</verification>

<success_criteria>
- Zod and Resend packages are installed and importable
- Shared Zod schema validates all 5 contact form fields with min/max constraints
- Server action handles the full flow: honeypot check -> Zod validation -> Resend email -> typed response
- Both translation files contain the complete `contact.*` namespace with zero key mismatches
- .env.example documents all new environment variables
</success_criteria>

<output>
After completion, create `.planning/phases/05-contact-form-conversion/05-01-SUMMARY.md`
</output>
