---
phase: 05-contact-form-conversion
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/contact/contact-form.tsx
  - src/app/[locale]/contact/page.tsx
  - src/components/layout/whatsapp-button.tsx
  - src/app/[locale]/layout.tsx
autonomous: true
requirements:
  - CONT-01
  - CONT-02
  - CONT-06
  - CONT-07
  - CONT-08
  - CONT-09

must_haves:
  truths:
    - "Contact page displays a form with name, email, message (required) and company, service interest (optional) with proper labels and placeholders in the current locale"
    - "Validation errors appear below each field with aria-live regions for screen readers"
    - "Successful submission replaces the form with a success message including response time expectation"
    - "Failed submission shows an error message with a retry option without losing user input"
    - "WhatsApp floating button is visible on all pages at the bottom-right corner"
    - "WhatsApp button links to wa.me with a pre-filled Spanish message"
  artifacts:
    - path: "src/components/contact/contact-form.tsx"
      provides: "Client component with useActionState for contact form UI"
      exports: ["ContactForm"]
    - path: "src/app/[locale]/contact/page.tsx"
      provides: "Contact page composing server wrapper with client form"
      exports: ["default", "generateStaticParams"]
    - path: "src/components/layout/whatsapp-button.tsx"
      provides: "Floating WhatsApp CTA button"
      exports: ["WhatsAppButton"]
  key_links:
    - from: "src/components/contact/contact-form.tsx"
      to: "src/app/[locale]/contact/actions.ts"
      via: "import submitContactForm for useActionState"
      pattern: "import.*submitContactForm.*from.*actions"
    - from: "src/components/contact/contact-form.tsx"
      to: "messages/es.json"
      via: "useTranslations('contact') for labels and errors"
      pattern: "useTranslations.*contact"
    - from: "src/app/[locale]/contact/page.tsx"
      to: "src/components/contact/contact-form.tsx"
      via: "import ContactForm component"
      pattern: "import.*ContactForm.*from.*contact/contact-form"
    - from: "src/app/[locale]/layout.tsx"
      to: "src/components/layout/whatsapp-button.tsx"
      via: "import and render WhatsAppButton in layout"
      pattern: "import.*WhatsAppButton.*from.*layout/whatsapp-button"
---

<objective>
Build the contact form UI with accessible validation, success/error states, and a WhatsApp floating CTA button visible on all pages.

Purpose: Delivers the user-facing form that connects to the server action from Plan 01, plus the WhatsApp conversion touchpoint visible site-wide.
Output: Working contact form with full validation UX and a floating WhatsApp button on every page.
</objective>

<execution_context>
@C:/Users/matia/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-contact-form-conversion/05-RESEARCH.md
@.planning/phases/05-contact-form-conversion/05-01-SUMMARY.md
@src/app/[locale]/contact/page.tsx
@src/app/[locale]/contact/actions.ts
@src/app/[locale]/layout.tsx
@src/lib/schemas/contact.ts
@messages/es.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build contact form client component and update contact page</name>
  <files>
    src/components/contact/contact-form.tsx
    src/app/[locale]/contact/page.tsx
  </files>
  <action>
1. Create `src/components/contact/contact-form.tsx` as a `'use client'` component:

   - Import `useActionState` from `'react'`
   - Import `useTranslations` from `'next-intl'`
   - Import `submitContactForm` and `ContactFormState` from `@/app/[locale]/contact/actions`
   - Import `cn` from `@/lib/utils`

   - Define `initialState: ContactFormState = { success: null }`

   - Export `ContactForm` component:
     a. Call `useTranslations('contact')` for `t` function
     b. Call `useActionState(submitContactForm, initialState)` to get `[state, formAction, pending]`

     c. **Success state (CONT-06):** If `state.success === true`, render a success panel:
        - Centered container with `rounded-lg border border-accent/30 bg-accent/5 p-8 text-center`
        - Checkmark icon or `âœ“` character in accent color
        - `<h3>` with `t('success.title')` -- bold, text-xl
        - `<p>` with `t('success.message')` -- muted text with response time expectation
        - Return early (do not render form)

     d. **Form rendering (CONT-01, CONT-02):**
        - `<form action={formAction} noValidate className="space-y-6">`
        - Add `noValidate` to suppress browser validation bubbles (we provide custom error UI)

        - **Server error banner (CONT-07):** If `state.message === 'server_error'`, render a red alert banner at the top of the form:
          - `role="alert"` for accessibility
          - `rounded-lg border border-red-300 bg-red-50 p-4`
          - Text from `t('errors.serverError')`

        - **Name field (required):**
          - `<label htmlFor="name">` with `t('fields.name.label')` + ` *`
          - `<input id="name" name="name" type="text" required aria-required="true">`
          - `aria-invalid={!!state.errors?.name}`
          - `aria-describedby={state.errors?.name ? 'name-error' : undefined}`
          - `placeholder={t('fields.name.placeholder')}`
          - Styling: `w-full rounded-md border px-4 py-3 transition-colors focus:outline-none focus:ring-2 focus:ring-accent/50 focus:border-accent`
          - Error border: `cn('border-border', state.errors?.name && 'border-red-500')`
          - Error message: `<p id="name-error" aria-live="polite" className="mt-1 text-sm text-red-600">{state.errors?.name && t('errors.nameRequired')}</p>`

        - **Email field (required):** Same pattern as name but:
          - `type="email"`, `id="email"`, `name="email"`
          - Error message logic: If `state.errors?.email` exists, check if the array contains an "Invalid email" type error to decide between `t('errors.emailRequired')` and `t('errors.emailInvalid')`. Simplification: if errors exist and the field was filled (check by looking at the error type), show emailInvalid, otherwise show emailRequired. Alternatively, just show the first relevant translated error. Simplest approach: map Zod error codes -- if `state.errors?.email` contains any error, display `t('errors.emailInvalid')` (covers both empty and invalid since both are email errors).

        - **Company field (optional):**
          - `type="text"`, `id="company"`, `name="company"`
          - No `required` attribute, no `aria-required`
          - No error display needed (optional field with only max-length constraint)
          - Label does NOT have ` *` asterisk

        - **Service interest field (optional, CONT-01):**
          - Use a `<select>` element: `id="serviceInterest"`, `name="serviceInterest"`
          - Default option: `<option value="">{t('fields.serviceInterest.placeholder')}</option>`
          - Map through service options: advisory, delivery, alignment, fractional, other
          - Each option: `<option value="advisory">{t('fields.serviceInterest.options.advisory')}</option>`
          - Same styling as text inputs but with `appearance-none` for custom styling

        - **Message field (required):**
          - Use `<textarea>` instead of `<input>`: `id="message"`, `name="message"`, `rows={5}`
          - `required`, `aria-required="true"`, same error pattern as name/email
          - Error: If errors exist, show `t('errors.messageTooShort')` (covers both empty and too-short since min is 10)

        - **Honeypot field (CONT-05):**
          - Wrap in `<div aria-hidden="true" style={{ position: 'absolute', left: '-9999px', opacity: 0 }}>`
          - `<label htmlFor="website_url">Website</label>`
          - `<input id="website_url" name="website_url" type="text" tabIndex={-1} autoComplete="one-time-code" />`

        - **Submit button:**
          - `<button type="submit" disabled={pending}>`
          - Full width: `w-full rounded-lg bg-accent px-6 py-4 font-bold text-white transition-opacity`
          - Disabled state: `disabled:opacity-60 disabled:cursor-not-allowed`
          - Text: `{pending ? t('fields.submit.sending') : t('fields.submit.label')}`

2. Update `src/app/[locale]/contact/page.tsx` to replace the stub:

   - Keep the existing imports (`getTranslations`, `setRequestLocale`, `routing`, `generateStaticParams`)
   - Add import: `ContactForm` from `@/components/contact/contact-form`
   - Change `getTranslations` namespace from `'pages.contact'` to `'contact'` (new namespace)
   - Update the page layout:
     - Section with responsive padding: `px-4 py-16 md:py-20 lg:py-24`
     - Max-width container: `mx-auto max-w-2xl` (narrower than current max-w-4xl for form focus)
     - `<h1>` centered: `text-3xl md:text-4xl lg:text-5xl font-bold text-center`
     - `<p>` subtitle centered: `mt-4 text-center text-muted text-base md:text-lg`
     - Form container: `<div className="mt-12"><ContactForm /></div>`

   NOTE: The contact form uses `useTranslations('contact')` for its own translation access. The page wrapper uses `getTranslations('contact')` for the title and subtitle only. Both read from the same `contact.*` namespace created in Plan 01.
  </action>
  <verify>
    - `src/components/contact/contact-form.tsx` exists and has `'use client'` directive
    - `src/app/[locale]/contact/page.tsx` imports and renders `ContactForm`
    - `npm run build` compiles without errors (or `npx tsc --noEmit` for type checking)
    - Contact form renders 5 visible fields (name, email, company, serviceInterest, message) plus hidden honeypot
    - Each required field has `aria-required="true"` and associated error display with `aria-live="polite"`
    - Submit button shows "Enviando..." / "Sending..." text when pending
  </verify>
  <done>Contact page renders a fully accessible form with 5 fields (3 required, 2 optional), honeypot spam protection, translated labels/placeholders/errors, pending state on submit button, success panel on completion, and error banner with retry on failure.</done>
</task>

<task type="auto">
  <name>Task 2: Create WhatsApp floating button and add to layout</name>
  <files>
    src/components/layout/whatsapp-button.tsx
    src/app/[locale]/layout.tsx
    messages/es.json
    messages/en.json
  </files>
  <action>
1. Create `src/components/layout/whatsapp-button.tsx` as a `'use client'` component:

   - Import `useTranslations` from `'next-intl'`

   - Define constants at module level:
     ```typescript
     const WHATSAPP_NUMBER = process.env.NEXT_PUBLIC_WHATSAPP_NUMBER || '5215512345678';
     const WHATSAPP_MESSAGE = 'Hola, me interesa conocer mas sobre tus servicios de consultoria.';
     ```
     NOTE: The pre-filled message is ALWAYS in Spanish per CONT-09, regardless of the user's current locale. The phone number needs `NEXT_PUBLIC_` prefix since this is a client component, OR simply hardcode it as a constant since it rarely changes. Prefer a hardcoded constant to avoid the NEXT_PUBLIC_ complexity -- the number can be updated in code when known.

   - Export `WhatsAppButton` component:
     - `const t = useTranslations('common')`
     - Build URL: `const whatsappUrl = \`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(WHATSAPP_MESSAGE)}\``
     - Render an `<a>` tag:
       - `href={whatsappUrl}`
       - `target="_blank"` `rel="noopener noreferrer"`
       - `aria-label={t('whatsapp')}` for accessibility
       - Positioning: `fixed bottom-6 right-6 z-40` (z-40 is below header z-50 but above content)
       - Size and shape: `flex h-14 w-14 items-center justify-center rounded-full`
       - WhatsApp brand green: `bg-[#25D366] hover:bg-[#20BD5C]`
       - Shadow and transition: `shadow-lg transition-colors`
       - Text color: `text-white`
     - Inside the `<a>`, render an inline SVG WhatsApp icon:
       - `<svg viewBox="0 0 24 24" className="h-7 w-7 fill-current" aria-hidden="true">`
       - Use the standard WhatsApp SVG path from the research document (the full path data is in 05-RESEARCH.md Pattern 5)

2. Add `common.whatsapp` translation key to both JSON files:

   - `messages/es.json`: Add under `common`: `"whatsapp": "Contactar por WhatsApp"`
   - `messages/en.json`: Add under `common`: `"whatsapp": "Contact via WhatsApp"`

   IMPORTANT: Do NOT restructure or reformat the existing JSON. Only add the new key under the existing `common` object.

3. Update `src/app/[locale]/layout.tsx` to include WhatsAppButton:

   - Add import: `import { WhatsAppButton } from '@/components/layout/whatsapp-button';`
   - Render `<WhatsAppButton />` inside the `<NextIntlClientProvider>`, after `<Footer />`:
     ```tsx
     <NextIntlClientProvider>
       <Header />
       <main className="flex-1">
         {children}
       </main>
       <Footer />
       <WhatsAppButton />
     </NextIntlClientProvider>
     ```
   - The button renders at a fixed position so its DOM location doesn't affect visual layout.
  </action>
  <verify>
    - `src/components/layout/whatsapp-button.tsx` exists with `'use client'` directive
    - `src/app/[locale]/layout.tsx` imports and renders `WhatsAppButton`
    - `npm run build` compiles without errors
    - WhatsApp button appears at bottom-right on all pages (check / route, /contact route)
    - WhatsApp link URL contains `wa.me/` with `?text=` parameter
    - `messages/es.json` and `messages/en.json` both have `common.whatsapp` key
  </verify>
  <done>WhatsApp floating button is visible on all pages at the bottom-right corner, linking to wa.me with a pre-filled Spanish message. The button uses the official WhatsApp brand green color, has an accessible aria-label from translations, and renders on both mobile and desktop viewports.</done>
</task>

</tasks>

<verification>
1. Contact form renders with all 5 fields on /es/contact and /en/contact
2. Required fields show translated error messages when submitting empty
3. Success panel appears after successful submission (test with valid Resend API key, or verify the state transition logic)
4. Error banner appears when server action returns server_error
5. Honeypot field is invisible to users but present in DOM
6. WhatsApp button appears on all pages (home, bio, services, contact)
7. WhatsApp link URL includes phone number and pre-filled Spanish message
8. All text comes from translation files (no hardcoded strings in components)
9. `npm run build` completes without errors
</verification>

<success_criteria>
- Contact page displays a complete, accessible form with 5 fields, validation errors, success state, and error state
- Honeypot field is invisible but functional for spam prevention
- WhatsApp floating button is visible on all pages with correct wa.me link
- All user-facing text is translated via next-intl (zero hardcoded strings)
- Full site builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-contact-form-conversion/05-02-SUMMARY.md`
</output>
