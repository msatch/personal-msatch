---
phase: 08-privacy-analytics-foundation
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - src/components/analytics/analytics-provider.tsx
  - src/components/analytics/cookie-consent.tsx
  - src/app/[locale]/layout.tsx
autonomous: true
requirements: [ANLYT-01, ANLYT-02]

must_haves:
  truths:
    - "Google Tag Manager loads on every page via next/script with afterInteractive strategy"
    - "Consent defaults are set to denied synchronously in the head before GTM initializes"
    - "GA4 is configured as a tag inside GTM only -- no separate gtag.js script in the codebase"
    - "Visitor sees a bilingual cookie consent banner on first visit with accept and decline buttons"
    - "Accepting cookies calls gtag consent update with analytics_storage granted"
    - "Rejecting cookies keeps analytics_storage denied and hides the banner"
    - "Consent persists across page refreshes and locale switches via cookie with path=/"
    - "Returning visitor who already decided does not see the banner again"
  artifacts:
    - path: "src/components/analytics/analytics-provider.tsx"
      provides: "GTM script loader with afterInteractive strategy"
      contains: "gtm.js"
      exports: ["AnalyticsProvider"]
    - path: "src/components/analytics/cookie-consent.tsx"
      provides: "Bilingual consent banner with accept/reject and gtag consent update"
      contains: "cookie_consent"
      exports: ["CookieConsentBanner"]
    - path: "src/app/[locale]/layout.tsx"
      provides: "Layout with consent defaults in head, AnalyticsProvider and CookieConsentBanner integrated"
      contains: "AnalyticsProvider"
  key_links:
    - from: "src/app/[locale]/layout.tsx"
      to: "src/components/analytics/analytics-provider.tsx"
      via: "import and render AnalyticsProvider"
      pattern: "AnalyticsProvider"
    - from: "src/app/[locale]/layout.tsx"
      to: "src/components/analytics/cookie-consent.tsx"
      via: "import and render CookieConsentBanner inside NextIntlClientProvider"
      pattern: "CookieConsentBanner"
    - from: "src/components/analytics/cookie-consent.tsx"
      to: "window.gtag"
      via: "gtag consent update call on user choice"
      pattern: "gtag.*consent.*update"
    - from: "src/app/[locale]/layout.tsx head"
      to: "window.dataLayer"
      via: "inline script setting consent defaults before GTM"
      pattern: "consent.*default.*denied"
---

<objective>
Create the AnalyticsProvider component (GTM loader), the CookieConsentBanner component (bilingual consent UI), add consent defaults inline script in the layout head, and wire both components into the locale layout.

Purpose: ANLYT-01 requires GTM to load on all pages. ANLYT-02 requires GA4 to be configured as a tag inside GTM only (no separate script). The consent banner ensures privacy compliance by defaulting to denied and letting visitors choose.

Output: Two new Client Components in src/components/analytics/, modified locale layout with consent defaults and component integration.
</objective>

<execution_context>
@C:/Users/matia/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/matia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-privacy-analytics-foundation/08-RESEARCH.md
@.planning/phases/08-privacy-analytics-foundation/08-01-SUMMARY.md

@src/app/[locale]/layout.tsx
@src/types/gtag.d.ts

<interfaces>
<!-- From Plan 01: TypeScript globals (src/types/gtag.d.ts) -->

```typescript
declare global {
  interface Window {
    dataLayer: Record<string, unknown>[];
    gtag: (...args: unknown[]) => void;
  }
}
export {};
```

<!-- From Plan 01: Consent translations (messages/*.json) -->

```json
// consent namespace (both locales)
{
  "consent": {
    "ariaLabel": "Cookie preferences / Preferencias de cookies",
    "message": "We use analytics cookies... / Usamos cookies de análisis...",
    "accept": "Accept / Aceptar",
    "reject": "Decline / Rechazar",
    "privacyLink": "Privacy policy / Política de privacidad"
  }
}
```

<!-- Locale layout structure (src/app/[locale]/layout.tsx) -->

```typescript
// Current structure:
<html lang={locale} suppressHydrationWarning>
  <head>
    <script dangerouslySetInnerHTML={{ __html: `(function(){...theme...})()` }} />
  </head>
  <body className={`${geistSans.variable} ${geistMono.variable} min-h-screen flex flex-col`}>
    <a href="#main-content" className="sr-only ...">...</a>
    <ThemeSync />
    <NextIntlClientProvider>
      <Header />
      <main id="main-content" className="flex-1">{children}</main>
      <Footer />
      <WhatsAppButton />
    </NextIntlClientProvider>
  </body>
</html>
```

<!-- WhatsApp button positioning (for z-index awareness) -->
<!-- WhatsAppButton uses: fixed bottom-6 right-6 z-50 -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnalyticsProvider and CookieConsentBanner components</name>
  <files>src/components/analytics/analytics-provider.tsx, src/components/analytics/cookie-consent.tsx</files>
  <action>
**File 1: Create `src/components/analytics/analytics-provider.tsx`**

Create a Client Component that loads the GTM container script. This component does NOT handle consent defaults (those go in the layout head as a raw inline script for synchronous execution).

```typescript
'use client';

import Script from 'next/script';

const GTM_ID = process.env.NEXT_PUBLIC_GTM_ID;

export function AnalyticsProvider() {
  if (!GTM_ID) return null;

  return (
    <Script
      id="gtm-script"
      strategy="afterInteractive"
      dangerouslySetInnerHTML={{
        __html: `
          (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
          new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
          j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
          'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
          })(window,document,'script','dataLayer','${GTM_ID}');
        `,
      }}
    />
  );
}
```

Key decisions:
- Uses `afterInteractive` strategy (NOT `beforeInteractive`) per research. `beforeInteractive` must go in root `app/layout.tsx` which is a pass-through in this project.
- GTM_ID comes from `NEXT_PUBLIC_GTM_ID` env var (client-side accessible).
- Returns null when GTM_ID is not set (dev environments without GTM configured).
- ONLY loads the GTM container script. Does NOT load a separate GA4/gtag.js script -- GA4 is configured as a tag inside GTM (ANLYT-02).

**File 2: Create `src/components/analytics/cookie-consent.tsx`**

Create a Client Component for the bilingual cookie consent banner:

```typescript
'use client';

import { useState, useEffect, useCallback } from 'react';
import { useTranslations } from 'next-intl';
import { Link } from '@/i18n/navigation';

const CONSENT_KEY = 'cookie_consent_v1';
const CONSENT_COOKIE = 'cookie_consent';
type ConsentChoice = 'accepted' | 'rejected';

export function CookieConsentBanner() {
  const t = useTranslations('consent');
  const [visible, setVisible] = useState(false);

  useEffect(() => {
    const stored = localStorage.getItem(CONSENT_KEY) as ConsentChoice | null;
    if (stored === 'accepted' || stored === 'rejected') {
      updateGtagConsent(stored);
    } else {
      setVisible(true);
    }
  }, []);

  const handleChoice = useCallback((choice: ConsentChoice) => {
    setVisible(false);
    localStorage.setItem(CONSENT_KEY, choice);
    document.cookie = `${CONSENT_COOKIE}=${choice};max-age=${365 * 24 * 60 * 60};path=/;SameSite=Lax`;
    updateGtagConsent(choice);
  }, []);

  if (!visible) return null;

  return (
    <div
      role="dialog"
      aria-label={t('ariaLabel')}
      className="fixed bottom-0 inset-x-0 z-50 border-t border-border bg-surface shadow-lg"
    >
      <div className="mx-auto max-w-4xl px-4 py-3 flex flex-col sm:flex-row items-start sm:items-center gap-3">
        <p className="text-sm flex-1">
          {t('message')}{' '}
          <Link href="/privacy" className="underline text-accent hover:text-accent/80">
            {t('privacyLink')}
          </Link>
        </p>
        <div className="flex gap-3 shrink-0">
          <button
            onClick={() => handleChoice('rejected')}
            className="px-4 py-2 text-sm border border-border rounded-md hover:bg-muted/10 transition-colors"
          >
            {t('reject')}
          </button>
          <button
            onClick={() => handleChoice('accepted')}
            className="px-4 py-2 text-sm bg-accent text-on-accent rounded-md hover:bg-accent/90 transition-colors"
          >
            {t('accept')}
          </button>
        </div>
      </div>
    </div>
  );
}

function updateGtagConsent(choice: ConsentChoice) {
  if (typeof window !== 'undefined' && typeof window.gtag === 'function') {
    window.gtag('consent', 'update', {
      analytics_storage: choice === 'accepted' ? 'granted' : 'denied',
    });
  }
}
```

Key decisions:
- Uses `useTranslations('consent')` for bilingual text (requires placement inside `NextIntlClientProvider`).
- Persistence via BOTH localStorage (fast client read) and cookie with `path=/` (survives locale switches between /es/ and /en/).
- `role="dialog"` and `aria-label` for accessibility.
- Only `analytics_storage` is updated on accept. `ad_storage`, `ad_user_data`, `ad_personalization` stay permanently denied (no advertising on this site).
- Banner is slim (py-3, text-sm) to avoid covering hero CTA on mobile. Uses `z-50` matching existing WhatsApp button. The banner is full-width at the bottom, so the WhatsApp button (positioned at bottom-6 right-6) will visually sit above it.
- Link to privacy policy uses the i18n-aware `Link` component from `@/i18n/navigation`.
- `wait_for_update: 500` in consent defaults (set in layout head) gives the banner 500ms to fire the update call for returning visitors who already consented.
  </action>
  <verify>
    <automated>cd "C:/Users/matia/OneDrive/Escritorio/mgripe/all-claude/personal-msatch" && test -f src/components/analytics/analytics-provider.tsx && test -f src/components/analytics/cookie-consent.tsx && npx next build 2>&1 | tail -5</automated>
  </verify>
  <done>
- AnalyticsProvider component exists, exports AnalyticsProvider function, loads GTM via next/script afterInteractive
- CookieConsentBanner component exists, exports CookieConsentBanner function, uses useTranslations('consent')
- No separate gtag.js or GA4 script in the codebase (only GTM container)
- Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire analytics into locale layout with consent defaults in head</name>
  <files>src/app/[locale]/layout.tsx</files>
  <action>
Modify `src/app/[locale]/layout.tsx` to add three things:

**Change 1: Add imports**

Add these imports at the top of the file:
```typescript
import { AnalyticsProvider } from '@/components/analytics/analytics-provider';
import { CookieConsentBanner } from '@/components/analytics/cookie-consent';
```

**Change 2: Add consent defaults inline script in `<head>`**

After the existing theme detection script in `<head>`, add a new raw `<script>` tag for Consent Mode v2 defaults. This MUST run synchronously before GTM loads:

```tsx
<script
  dangerouslySetInnerHTML={{
    __html: `window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('consent','default',{'ad_storage':'denied','ad_user_data':'denied','ad_personalization':'denied','analytics_storage':'denied','wait_for_update':500});`,
  }}
/>
```

This sets ALL consent categories to denied by default. The `wait_for_update: 500` gives the CookieConsentBanner 500ms to call `gtag('consent', 'update', ...)` for returning visitors before GTM processes any tags.

**Change 3: Add AnalyticsProvider and CookieConsentBanner in the body**

Place `<AnalyticsProvider />` OUTSIDE `NextIntlClientProvider` (it does not need translations), after `<ThemeSync />`:

```tsx
<ThemeSync />
<AnalyticsProvider />
<NextIntlClientProvider>
```

Place `<CookieConsentBanner />` INSIDE `NextIntlClientProvider` (it uses `useTranslations`), after `<WhatsAppButton />`:

```tsx
  <WhatsAppButton />
  <CookieConsentBanner />
</NextIntlClientProvider>
```

**Final layout structure should be:**
```tsx
<html lang={locale} suppressHydrationWarning>
  <head>
    {/* Theme detection (existing) */}
    <script dangerouslySetInnerHTML={{ __html: `(function(){...theme...})()` }} />
    {/* Consent Mode v2 defaults (NEW) */}
    <script dangerouslySetInnerHTML={{ __html: `window.dataLayer=...consent defaults...` }} />
  </head>
  <body className={...}>
    <a href="#main-content" ...>...</a>
    <ThemeSync />
    <AnalyticsProvider />           {/* NEW: outside NextIntlClientProvider */}
    <NextIntlClientProvider>
      <Header />
      <main id="main-content" className="flex-1">{children}</main>
      <Footer />
      <WhatsAppButton />
      <CookieConsentBanner />       {/* NEW: inside NextIntlClientProvider */}
    </NextIntlClientProvider>
  </body>
</html>
```

**Critical ordering rules:**
1. Consent defaults raw script in `<head>` runs first (synchronous)
2. AnalyticsProvider (GTM) loads after page hydration via `afterInteractive`
3. CookieConsentBanner mounts, checks localStorage, and fires `gtag('consent', 'update')` within the 500ms window if user previously consented
  </action>
  <verify>
    <automated>cd "C:/Users/matia/OneDrive/Escritorio/mgripe/all-claude/personal-msatch" && npx next build 2>&1 | tail -5 && grep -c "AnalyticsProvider" src/app/\[locale\]/layout.tsx && grep -c "CookieConsentBanner" src/app/\[locale\]/layout.tsx && grep -c "consent.*default" src/app/\[locale\]/layout.tsx</automated>
  </verify>
  <done>
- Locale layout imports and renders AnalyticsProvider (outside NextIntlClientProvider)
- Locale layout imports and renders CookieConsentBanner (inside NextIntlClientProvider)
- Consent defaults inline script exists in head with all 4 Consent Mode v2 parameters denied
- AnalyticsProvider renders after ThemeSync, before NextIntlClientProvider
- CookieConsentBanner renders after WhatsAppButton, inside NextIntlClientProvider
- Build succeeds
- Only gtm.js loads (no separate gtag/js script in codebase)
  </done>
</task>

</tasks>

<verification>
1. `npx next build` succeeds without errors
2. `grep -r "gtag/js\|googletagmanager.com/gtag" src/` returns zero results (no separate GA4 script -- ANLYT-02)
3. `grep -c "gtm.js" src/components/analytics/analytics-provider.tsx` returns 1 (GTM loads -- ANLYT-01)
4. `grep -c "consent.*default" src/app/\[locale\]/layout.tsx` returns 1 (consent defaults set before GTM)
5. `grep -c "analytics_storage.*denied" src/app/\[locale\]/layout.tsx` returns 1 (defaults to denied)
6. `grep -c "AnalyticsProvider" src/app/\[locale\]/layout.tsx` returns at least 2 (import + render)
7. `grep -c "CookieConsentBanner" src/app/\[locale\]/layout.tsx` returns at least 2 (import + render)
8. No `@next/third-parties` imports anywhere in the codebase
</verification>

<success_criteria>
- GTM container script loads on every page via next/script with afterInteractive strategy (ANLYT-01)
- GA4 is NOT loaded as a separate script -- only GTM container ID appears in code (ANLYT-02)
- Consent Mode v2 defaults are set synchronously in head before GTM initializes (all 4 parameters denied)
- Cookie consent banner renders in both Spanish and English with accept and decline buttons
- Accepting cookies updates analytics_storage to granted via gtag consent update
- Rejecting cookies keeps analytics_storage denied
- Consent persists across page refreshes and locale switches (cookie with path=/, localStorage)
- Returning visitors who already decided do not see the banner
- Banner does not break mobile layout at 375px width
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-privacy-analytics-foundation/08-02-SUMMARY.md`
</output>
